#!/bin/sh -e
#
# Try to load Redshift if available, with coordinates from the IP
# location, after network is available.
#

if ! command -v redshift; then
    exit 1
fi

coords() {
    curl 'https://freegeoip.net/xml/' \
        | awk -F'>|<' '
            $2 == "Latitude" { lat=$3 }
            $2 == "Longitude" { lon=$3 }

            END {
                if (!lat || !lon) exit 1
                print lat ":" lon
            }
        '
}

# Dirty patch to wait for network
while ! coords=$(coords); do
    sleep 1

    i="${i}-"

    # Abort after 10 seconds
    if [ "$i" == '----------' ]; then
        exit 1
    fi
done

# Use GeoClue provider
exec redshift -l "$coords"
