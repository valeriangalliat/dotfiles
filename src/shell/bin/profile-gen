#!/bin/sh -e

dir=$(dirname "$0")

mkdir -p ~/.cache/shell

# Reset profile cache
> ~/.cache/shell/profile

cache() {
    echo "export $1='$2'" >> ~/.cache/shell/profile
}

PROFILE_LINUX=false
PROFILE_BSD=false
PROFILE_OPENBSD=false
PROFILE_FREEBSD=false

# No fallthrough in classic shell
case "$(uname)" in
    *BSD) PROFILE_BSD=true ;;
esac

case "$(uname)" in
    Linux) PROFILE_LINUX=true ;;
    OpenBSD) PROFILE_OPENBSD=true ;;
    FreeBSD) PROFILE_FREEBSD=true ;;
esac

cache PROFILE_LINUX "$PROFILE_LINUX"
cache PROFILE_BSD "$PROFILE_BSD"
cache PROFILE_OPENBSD "$PROFILE_OPENBSD"
cache PROFILE_FREEBSD "$PROFILE_FREEBSD"

# Source cached profile generator
. ~/.config/shell/profile.gen

#
# Use `set` to dump all defined variables and find the lines beginning
# with `GRACEFUL_` to process them.
#
set | while read l; do
    # Pass if the line does not begins with `GRACEFUL_`
    echo "$l" | grep -qv '^GRACEFUL_' && continue

    # Delete everything after `=` (graceful variable)
    g=$(echo "$l" | sed 's/=.*//')

    # Delete prefix (final export)
    e=$(echo "$g" | sed 's/^GRACEFUL_//')

    # Extract the graceful variable (value)
    v=$(eval "echo \$$g")

    # Use comma as loop separator
    IFS=,

    for c in $v; do
        # Restore separator (won't affect main loop)
        unset IFS

        # Extract first item (command name)
        for cn in $c; do break; done

        # Use the `command` builtin to check for existing commands
        if command -v "$cn" > /dev/null; then
            # Cache command with arguments
            cache "$e" "$c"
            break
        fi
    done

    # Ensure normal separator (if the loop was empty)
    unset IFS
done
