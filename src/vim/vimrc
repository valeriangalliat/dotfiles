"
" ~/.vimrc
"

" Initialization {{{
" ==================

    " Don't use system Vim configuration
    set noexrc

    " Leave compatible mode alone
    if &compatible
        finish
    endif

    " VAM {{{
    " -------

        set runtimepath+=~/.vim/vim-addons/vim-addon-manager

        if !isdirectory(expand('~/.vim/vim-addons/vim-addon-manager'))
            " Download VAM and try again
            silent! !mkdir -p ~/.vim/vim-addons
            silent! !git clone --depth 1 git://github.com/MarcWeber/vim-addon-manager ~/.vim/vim-addons/vim-addon-manager
        endif

    " }}}

" }}}

" Plugins {{{
" ===========

    " VAM plugins (compiled, edit `plugins` for source)
    source $DOTFILES/src/vim/plugins.vim

    " Fuzzy finder (fast, external)
    set runtimepath+=$DOTFILES/deps/shell/fzf

" }}}

" Essentials {{{
" ==============

    " Force `sensible` to load before vimrc
    runtime! plugin/sensible.vim

    " Display line numbers
    set number

    " Highlight cursor line
    set cursorline

    " Show 80 chars limit
    set colorcolumn=80

    " UTF-8 support without BOM
    set encoding=utf-8 nobomb

    " No word wrap
    set nowrap

    " Silently change unsaved buffer
    set hidden

    " See `:help fo-table`
    set formatoptions+=croqnlj
    set formatoptions-=t

    " Do not reset cursor with some commands (like `H`, `M`, `L`)
    set nostartofline

    " Do not create `.swp` files
    " set noswapfile

    " Read `.vimrc` in the current directory
    set exrc

    " Secure mode for `exrc`
    set secure

    " No preview window during completion
    set completeopt-=preview

    " Keep 8 context lines when scrolling
    set scrolloff=8

    " No bounds when in visual block
    set virtualedit=block

    " Spell check language
    set spelllang=en

    " Set window title
    set title

    " Fold with markers
    set foldmethod=marker

    " Save edit history to file
    set undofile
    set undodir=~/.vim/undo

    " More natural split direction
    set splitbelow
    set splitright

    " Set leader
    let mapleader = ','

" }}}

" Optimization {{{
" ================

    " Fast terminal commections
    set ttyfast

    " Don't redraw when running macros
    set lazyredraw

    " Syntax optimization
    syntax sync minlines=256

    " Don't highlight past 512 characters
    " set synmaxcol=512

" }}}

" Theme {{{
" =========

    set background=dark
    let base16colorspace = 256
    colorscheme base16-default

    " No background color (see through Vim)
    highlight Normal ctermbg=none

" }}}

" Completion {{{
" ==============

    "
    " Complete until longest match. On tab, list matches. If tab is pressed
    " again, do full completion.
    "
    set wildmode=longest,list,full

    " Files to ignore in completion
    set wildignore+=*.o,*.out,*.so,*.class,*.pyc " Compiled binaries
    set wildignore+=*.tar,*.tar.*,*.zip,*.rar " Archives
    set wildignore+=*.jpg,*.jpeg,*.png,*.gif
    set wildignore+=*.gz,*.bz2,*.xz " Compressed files
    set wildignore+=.git,.svn,.hg " Version control

" }}}

" Indentation {{{
" ===============

    " Copy previous line indentation settings
    set copyindent

    " Use spaces instead of tabs
    set expandtab

    " Tab display width
    set tabstop=4

    " Remove 4 spaces with backspace
    set softtabstop=4

    " Indentation command width
    set shiftwidth=4

    " Always indent to a multiple of the configuration value
    set shiftround

    " Show whitespaces
    set listchars=tab:——,trail:•,extends:>,precedes:<,nbsp:•
    set list

    " Indentation helper {{{
    " ----------------------

        function! Indent(width)
            execute 'set ts='.a:width.' sts='.a:width.' sw='.a:width
        endfunction

        command! -nargs=1 Indent :call Indent(<f-args>)

    " }}}

" }}}

" Filetype associations {{{
" =========================

    " Text width {{{
    " --------------

        au FileType text set tw=72
        au FileType tex set tw=72
        au FileType markdown set tw=72

    " }}}

    " Indentation {{{
    " ---------------

        au FileType apache set et!
        au FileType gitconfig set et!

        au FileType javascript set ts=2 sts=2 sw=2
        au FileType coffee set ts=2 sts=2 sw=2
        au FileType ruby set ts=2 sts=2 sw=2
        au FileType json set ts=2 sts=2 sw=2
        au FileType html set ts=2 sts=2 sw=2 wrap
        au FileType markdown set ts=2 sts=2 sw=2 wrap
        au FileType twig set ts=2 sts=2 sw=2 wrap
        au FileType jade set ts=2 sts=2 sw=2 wrap
        au FileType haml set ts=2 sts=2 sw=2 wrap
        au FileType stylus set ts=2 sts=2 sw=2 wrap

    " }}}

    " Syntax {{{
    " ----------

        au BufRead,BufNewFile *.md set filetype=markdown
        au BufRead,BufNewFile *.ronn set filetype=markdown
        au BufRead,BufNewFile *.swig set filetype=twig

    " }}}

    " Comments {{{
    " ============

        au FileType php set cms=//\ %s

    " }}}

    " Reload {{{
    " ----------

        " au BufWritePost .vimrc source %
        " au BufWritePost vimrc source %
        au BufWritePost $DOTFILES/src/x11/resources silent! !xrdb-reload
        au BufWritePost ~/.config/x11/resources silent! !xrdb-reload

    " }}}

" }}}

" Search {{{
" ==========

    " Case insensitive
    set ignorecase

    " Sensitive completion
    set infercase

    " Sensitive search if upper characters
    set smartcase

" }}}

" Wrap {{{
" ========

    " Include the wrap lines for following moves
    noremap j gj
    noremap k gk

    " Do not break words
    set linebreak

" }}}

" Plugin settings {{{
" ===================

    " `airline` {{{
    " -------------

        let airline#extensions#tabline#enabled = 1
        " let airline_powerline_fonts = 1

    " }}}

    " `nerdtree` {{{
    " --------------

        map <silent> <Leader>n :NERDTreeTabsToggle<CR>

    " }}}

    " `detectindent` {{{
    " ------------------

        " au BufRead * DetectIndent

    " }}}

    " `fzf` {{{
    " ---------

        map <silent> <Leader>f :FZF<CR>

    " }}}

    " `unite` {{{
    " -----------

        " map <silent> <Leader>f :Unite file file/new directory/new<CR>
        map <silent> <Leader>r :Unite file_rec/async<CR>
        map <silent> <Leader>b :Unite buffer<CR>
        map <silent> <Leader>t :Unite tag<CR>
        map <silent> <Leader>g :Unite grep:.<CR>
        map <silent> <Leader>c :Unite colorscheme<CR>

        " Fuzzy matching and sort like `ctrlp`
        call unite#filters#matcher_default#use(['matcher_fuzzy'])
        call unite#filters#sorter_default#use(['sorter_length'])

        " Start in insert mode, and use the whole buffer
        call unite#custom#profile('default', 'context', {
            \ 'start_insert': 1,
            \ 'no_split': 1,
            \ })

    " }}}

    " `bufferline` {{{
    " ----------------

        " Do not echo since it's integrated in the status line
        let bufferline_echo = 0

        " Append buffer line to status line
        autocmd VimEnter *
            \ let &statusline = '%{bufferline#refresh_status()}'
            \ .bufferline#get_status_string()

    " }}}

    " `indentline` {{{
    " ----------------

        let indentLine_color_term = 236
        let indentLine_color_gui = '#32322f'
        let indentLine_char = '│'
        let indentLine_noConcealCursor = ''

    " }}}

    " `markdown` {{{
    " --------------

        " Do not fold
        let vim_markdown_folding_disabled = 1

    " }}}

    " `undotree` {{{
    " --------------

        map <silent> <Leader>u :UndotreeToggle<CR>

    " }}}

    " `easymotion` {{{
    " ----------------

        " Lower match upper
        let EasyMotion_smartcase = 1

        let EasyMotion_enter_jump_first = 1
        let EasyMotion_space_jump_first = 1

        " Improve standard moves
        map <Leader>l <Plug>(easymotion-lineforward)
        map <Leader>j <Plug>(easymotion-j)
        map <Leader>k <Plug>(easymotion-k)
        map <Leader>h <Plug>(easymotion-linebackward)

        " Keep cursor horizontal position
        let EasyMotion_startofline = 0

    " }}}

    " `syntastic` {{{
    " ---------------

        let syntastic_mode_map = {'mode': 'passive'}
        let syntastic_javascript_checkers = ['eslint', 'jshint', 'jslint']

    " }}}

    " `gist` {{{
    " ----------

        let gist_post_anonymous = 1

    " }}}

    " `easyclip` {{{
    " --------------

        let EasyClipUseCutDefaults = 0 " Do not remap `m`
        let EasyClipUseSubstituteDefaults = 1 " Remap `s`

        " Paste without format in insert mode
        imap <C-v> <plug>EasyClipInsertModePaste

        " Cut mappings
        nmap dx <Plug>MoveMotionPlug
        xmap dx <Plug>MoveMotionXPlug
        nmap dxx <Plug>MoveMotionLinePlug
        nmap dX <Plug>MoveMotionEndOfLinePlug
        nmap dxX <Plug>MoveMotionReplaceLinePlug

    " }}}

    " `neocomplcache` {{{
    " -------------------

        let neocomplcache_enable_at_startup = 1
        let neocomplcache_enable_smart_case = 1
        let neocomplcache_enable_auto_select = 1

    " }}}

    " `neosnippet` {{{
    " ----------------

        " Expand snippets with `<Tab>` (from project readme)
        imap <expr><Tab> neosnippet#expandable_or_jumpable()
            \ ? "\<Plug>(neosnippet_expand_or_jump)"
            \ : pumvisible() ? "\<C-n>" : "\<Tab>"

        " SnipMate compatibility
        let g:neosnippet#enable_snipmate_compatibility = 1
        let g:neosnippet#snippets_directory = '~/.vim/bundle/vim-snippets/snippets'

    " }}}

    " `supertab` {{{
    " --------------

        let SuperTabDefaultCompletionType = '<C-n>'

    " }}}

    " `auto-pairs` {{{
    " ----------------

        " Do not center line when expanding braces
        let g:AutoPairsCenterLine = 0

        " Allow to type `î` char
        let g:AutoPairsShortcutJump = ''

        " Allow to type `â` char
        let g:AutoPairsShortcutBackInsert = ''

    " }}}

    " `tagbar` {{{
    " ------------

        map <Leader>t :TagbarToggle<CR>

    " }}}

    " `switch` {{{
    " ------------

        nmap - :Switch<CR>

    " }}}

    " `nrrwrgn` {{{
    " -------------

        " Don't delay `<Leader>n`
        nmap <Plug>Nope <Plug>NrrwrgnDo

    " }}}

" }}}

" Mappings {{{
" ============

    " Use `Q` for formatting
    noremap Q gq

    " Logical `Y` behavior
    noremap Y y$

    " nmap <silent> <Left> :vertical resize -5<CR>
    " nmap <silent> <Up> :resize -5<CR>
    " nmap <silent> <Right> :vertical resize +5<CR>
    " nmap <silent> <Down> :resize +5<CR>

    " Open vimrc in split
    map <silent> <Leader>v :vsp ~/.vimrc<CR>

    " Shortcuts to browse buffers
    " map <silent> <C-n> :bn
    " map <silent> <C-p> :bp

" }}}

" Helpers {{{
" ===========

    " Cursor jump {{{
    " ---------------

        " Jump to last known cursor position
        autocmd BufReadPost *
            \ if line("'\"") > 1 && line("'\"") <= line('$') |
            \   exe 'normal! g`"' |
            \ endif

    " }}}

    " Toggle relative numbering
    " -------------------------

        function! NumberToggle()
            if &relativenumber
                set number
            else
                set relativenumber
            endif
        endfunc

        map <silent> <Leader>r :call NumberToggle()<CR>

    " }}}

" }}}
