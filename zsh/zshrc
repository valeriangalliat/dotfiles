#
# ~/.zshrc
#

# Initialization {{{
# ==================

    export ZSH="$DOTFILES/zsh/oh-my-zsh"

    # Don't mark untracked files as dirty (performance), used by `$ZSH/lib/git.zsh`
    DISABLE_UNTRACKED_FILES_DIRTY=true

    # Set `LS_COLORS` before `$ZSH/lib/theme-and-appearance.zsh` is loaded
    source "$DOTFILES/zsh/dircolors"

    autoload -U compinit
    compinit -d ~/.zcompdump

    # Load only what I want from `oh-my-zsh`
    source "$ZSH/lib/clipboard.zsh"
    source "$ZSH/lib/completion.zsh"
    source "$ZSH/lib/correction.zsh"
    source "$ZSH/lib/directories.zsh"
    source "$ZSH/lib/git.zsh"
    source "$ZSH/lib/grep.zsh"
    source "$ZSH/lib/history.zsh"
    source "$ZSH/lib/key-bindings.zsh"
    source "$ZSH/lib/termsupport.zsh"
    source "$ZSH/lib/theme-and-appearance.zsh"

    # Theme
    source "$ZSH/themes/robbyrussell.zsh-theme"

    # Plugins
    source "$ZSH/plugins/git/git.plugin.zsh"
    source "$ZSH/plugins/colored-man-pages/colored-man-pages.plugin.zsh"
    source "$ZSH/plugins/history-substring-search/history-substring-search.plugin.zsh"
    source "$DOTFILES/zsh/zsh-syntax-highlighting/zsh-syntax-highlighting.plugin.zsh"

# }}}

# Essentials {{{
# ==============

    # Allow adding comments in interactive session
    setopt interactivecomments

# }}}

# Theme {{{

    # Terminal colors (except in tmux)
    if [ -z "$TMUX" ]; then
        export BASE16_MODE=dark
        export BASE16_THEME=base16-default-dark

        if [ -f "$HOME/.dotfiles_color_theme" ]; then
            source "$HOME/.dotfiles_color_theme"
        fi

        source "$DOTFILES/zsh/base16-shell/scripts/$BASE16_THEME.sh"
    fi

    #
    # Disable changing title when command running to keep the working
    # directory in the title.
    #
    function omz_termsupport_preexec {
        return
    }

    # Add time to prompt instead of arrow
    PROMPT=$(echo "$PROMPT" | sed 's/âžœ /%T/g')

    # Prepend `user@host` to prompt when under SSH
    if [ -n "$SSH_CLIENT" ]; then
        PROMPT="%{$fg[cyan]%}%n@%{$fg[blue]%}%m ${PROMPT}"
    fi

# }}}

# Aliases {{{
# ===========

    # Shortcuts
    alias l=ll
    alias q=exit
    alias vi=vim

    # Globbing move command
    autoload zmv
    alias mmv='noglob zmv -W'

    alias rgm='rg --max-columns 1000'

    alias jcurl='curl -H "Content-Type: application/json"'

    #
    # Now many repos squash before merging, we can't rely on simple
    # `git branch --merged` to identify local branches to clean.
    #
    # This trick prunes all the branches that were deleted from upstream,
    # usually synonymous of them being merged (or closed) and we liekly
    # don't need the branch locally anymore, so goes and deletes the matching
    # local branch if any.
    #
    alias gprune='git remote prune origin | grep origin/ | cut -d/ -f2- | xargs git branch -D 2>1 | grep -v "not found"'

# }}}

# Functions {{{
# ===========

    function theme {
        export BASE16_MODE=$1; shift
        export BASE16_THEME=$1; shift
        echo "export BASE16_MODE=$BASE16_MODE" > ~/.dotfiles_color_theme
        echo "export BASE16_THEME=$BASE16_THEME" >> ~/.dotfiles_color_theme
        source "$DOTFILES/zsh/base16-shell/scripts/$BASE16_THEME.sh"
    }

    function tlight {
        theme light base16-atelier-plateau-light
    }

    function tdark {
        theme dark base16-default-dark
    }

# }}}
